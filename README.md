# win_liunx_floder_sync

# SFTP 文件同步工具

本项目提供了一个基于 `paramiko` 的 SFTP 文件同步工具，支持多线程下载、断点续传、文件完整性校验等功能，能够高效地将远程服务器上的文件同步到本地。

## 功能特性

-   **多线程下载:**  支持多线程并发下载，提高下载速度。
-   **断点续传:**  下载中断后，可以从上次中断的地方继续下载，避免重复下载。
-   **文件完整性校验:**  支持对已下载文件进行完整性校验，确保文件正确性。 大于256MB的文件会进行MD5校验，小于256MB的只进行文件大小校验。
-   **目录扫描:**  自动递归扫描远程目录，并同步整个目录结构。
-   **文件名清理:** 自动清理文件名中的非法字符，确保在不同操作系统下的兼容性。
-   **路径格式统一:** 将路径格式统一为 Windows 或非 Windows 格式，并处理特殊字符。
-   **进度显示:**  实时显示每个文件的下载进度和总体下载进度。
-   **异常处理:**  完善的异常处理机制，包括认证失败、SSH 连接失败、下载错误等。
-   **重试机制:**  下载失败时自动重试，提高下载成功率。
-   **文件过滤:**  默认跳过本地已存在且大小与远程文件相同的文件。
-   **UNC路径支持:** 支持处理和转换 UNC 路径（以 `\\` 开头）。
-   **长路径支持:** 支持处理超过 250 个字符的长路径。

## 依赖

-   `paramiko`
-   `tqdm`

可以使用以下命令安装依赖：

```bash
pip install paramiko tqdm
```

## 使用方法

1. **修改配置:**

    在 `main` 函数中修改以下配置：

    ```python
    hostname = ""  # 远程服务器地址
    username = ""  # 用户名
    password = ""  # 密码
    remote_dirs = []  # 远程目录列表
    local_dirs = []  # 本地目录列表,与远程目录一一对应
    ```

2. **运行脚本:**

    ```bash
    python main.py
    ```

## 代码结构

-   `FileTransfer` 类：
    -   `__init__`：初始化连接信息和配置。
    -   `connect`：建立 SSH 连接。
    -   `close`：关闭连接。
    -   `reconnect`：重新连接服务器。
    -   `sanitize_filename`：清理文件名。
    -   `normalize_path`：统一路径格式。
    -   `create_sftp_client`：创建 SFTP 客户端。
    -   `add_task_to_queue`：将下载任务添加到队列。
    -   `producer`：生产者线程，扫描远程目录并将文件添加到下载队列。
    -   `_scan_remote_dir`：递归扫描远程目录。
    -   `verify_file_integrity`：验证文件完整性。
    -   `download_file`：下载单个文件，支持断点续传和完整性验证。
    -   `consumer`：消费者线程，从队列中取出任务并下载文件。
    -   `_print_progress`：打印总体进度。
    -   `start_transfer`：开始传输过程。

-   `main` 函数：程序入口。

## 注意事项

-   确保远程服务器已开启 SFTP 服务。
-   根据实际情况修改 `main` 函数中的配置。
-   如果需要调整最大并发下载线程数，可以修改 `FileTransfer` 类初始化时的 `max_workers` 参数。
-   代码中默认的 SFTP 端口为 `12699`，如果需要修改，请在 `FileTransfer` 类初始化时指定 `port` 参数。
-   下载大文件时，进度条可能会出现跳动，这是由于 `tqdm` 的更新机制导致的，属于正常现象。

## 贡献

欢迎提出问题和改进建议，也欢迎提交 Pull Request。

## 许可

本项目基于 MIT 许可。

